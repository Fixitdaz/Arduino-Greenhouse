<!doctype html>
<html>
	<head>
	<meta charset="utf-8">
	<meta http-equiv="X-UA-Compatible" content="chrome=1">
	<title>Arduino-controlled Greenhouse</title>
	
	<!--
	<link rel="stylesheet" href="stylesheets/styles.css">
	<link rel="stylesheet" href="stylesheets/pygment_trac.css">
	-->
	<link rel="stylesheet" href="stylesheets/custom.css">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<!--[if lt IE 9]>
	<script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
	<![endif]-->
	</head>
	
	<body>
	
		<div class="wrapper">
			
			<!--
			<header>
				<h2>Arduino-greenhouse</h2>
				<p></p>
				
				<p class="view"><a href="https://github.com/cconway/Arduino-Greenhouse">View the Project on GitHub <small>cconway/Arduino-Greenhouse</small></a></p>
				
				
				<ul>
				<li><a href="https://github.com/cconway/Arduino-Greenhouse/zipball/master">Download <strong>ZIP File</strong></a></li>
				<li><a href="https://github.com/cconway/Arduino-Greenhouse/tarball/master">Download <strong>TAR Ball</strong></a></li>
				<li><a href="https://github.com/cconway/Arduino-Greenhouse">View On <strong>GitHub</strong></a></li>
				</ul>
			</header>
			-->
						
			<header>
				<h1>Arduino-controlled Greenhouse</h1>
								
				<ul>
					<li>Wireless monitoring and control with iOS app</li>
					<li>Powerful and efficient LED grow-lighting</li>
					<li>Automatic ventilation with Humidity &amp; Temperature setpoints</li>
					<li>Illumination scheduling</li>
					<li><a href="https://github.com/cconway/Arduino-Greenhouse">View On <strong>GitHub</strong></a></li>
				</ul>
								
			</header>
			
			<figure class="full-width">
				<img src="media/DSCF1930.jpg">
				<figcaption>View from the front, unmirrored side.</figcaption>
			</figure>
			
			<section>
			
				<div class="sleeve">
			
					<h2>An Introduction</h2>
				
					<p>I am an iOS app developer by day, but over the last few months I did some demo projects with Arduino and worked up to implementing custom Bluetooth LE communication using a "shield" by Redbear Labs. The next step was to put everything together into a real project that I could benefit from daily.</p>
					<p>The goal of this project is to put together a working greenhouse and in the process to build up my electrical engineering skills. The rapidly growing market for mobile apps is just a few years old but I believe that as it matures one of the main segments will be apps that can integrate with the&nbsp;<em>physical</em> things around us.</p>
					<p>I have chosen to start with a small, indoor greenhouse with integrated lighting. I will use a sealed container and various controls to manipulate the growing environment. The first two controls I will implement are the LED lighting system and ventilation control.</p>
					<p>I'll add sections roughly in the order that I complete the work with a mix of discussing the options I learned about in my research and instructions on how to recreate my build.</p>
					
				</div>
					
				</section>
				
				<section>
				
					<div class="sleeve">
					
					<h2>An Overview</h2>
					
						<p><em>Who</em> would this appeal to? For a thrifty gardener this could be a cheap way to enjoy the benefits of a more expensive commercial rig. For an agriculture student it could run an experiment. For the budding programmer it could be a practical exercise in writing code. For the engineering student it could be a fun way to practice control theory. For the advanced gardener it could maintain the microclimate suiting a fussy plant.</p>
						
						<p><em>How</em> does it work? In my case the greenhouse is a sealed Rubbermaid container filled with plants. To it I've added sensors to detect the humidity and temperature both inside the container and out. To control the interior climate there is a vent that can be opened and closed. To monitor the sensors and open and close the vent automatically I've added an Arduino, a small computer running a pre-loaded program. Finally, I've created an iOS app that communicates with the Arduino wirelessly. From that app you can monitor the status of the greenhouse as well as change settings in the program controlling the greenhouse environment. Those with programming experience will find it easy to modify the program even further to suite their needs.</p>
						
						<p><em>What</em> can you do with it? Just like a traditional greenhouse, the goal is to create an isolated climate that provides favorable conditions for plant growth. In the initial design we provide plants constant air movement, supplemental illumination, and passive control over humidity and temperature. The next most likely additions would be active control of humidity (a mister), active control of temperature (a heater), and automatic irrigation/feeding. A greenhouse would be great for growing herbs in the winter or starting seedlings before the last frost. You could setup a custom lighting schedule for plants that need special conditions to bloom. You could keep exotic or tropical plants alive in climates they're otherwise not well suited to.</p>
						
						<p><em>How</em> can I get involved? I've made the Arduino and iOS source code available on GitHub for others to use or build from. This page provides a lot of technical information and explanation of how I put my greenhouse together. With that I hope to share my 2Â¢ and help others in the future the way similar project pages have helped me. Many sections of this project are new territory for me so I'm very welcoming of feedback and suggestions.</p>
				
				</div>
				
			</section>
			
			<figure class="full-width">
				<img src="media/DSCF1965.jpg">
				<figcaption>Breadboard with dual constant current driver circuits.</figcaption>
			</figure>
			
			<section>
			
				<div class="sleeve">
				
					<h2>Lighting options</h2>
				
					<p>Because it was the furthest outside my comfort zone, I began with the high-power LED lighting system first. From some initial research I learned that Fluorescent tube, High-Pressure Sodium (HPS) and Metal Halide were the traditional choices for grow lighting, listed in order of increasing intensity (and price).&nbsp;The idea of LED lighting systems is not new, but is gaining in popularity as the efficiency of the LEDs increases and their price decreases.&nbsp;<a href="http://www.nasa.gov/centers/kennedy/home/plant_growth.html">NASA has evaluated</a>&nbsp;whether LED lighting would be a good fit for long mission space farming. The more recent "high-power" LEDs are in a different class from those we're familiar with as indicators in our consumer electronics: They consume hundreds of times more power and emit similarly greater amounts of light; these are the components that make LEDs a viable replacement for incandescent or compact-fluorescent light bulbs.</p>
					<p>One of the things drawing me to LED lighting was the notion of&nbsp;<a href="http://en.wikipedia.org/wiki/Photosynthetically_active_radiation">Photosynthetically Active Radiation</a>&nbsp;(PAR). This is the idea that the compounds in plants that drive photosynthesis (food production) respond better to specific colors of light. In a nutshell, very little light outside of the visible range (i.e. ultraviolet (UV) and infrared) is beneficial to photosynthesis and even within the visible range most colors between red and blue contribute very little. Looking at the&nbsp;<strong>Yield Photon Flux</strong>&nbsp;table, I chose to target the&nbsp;<strong>440nm</strong>&nbsp;and&nbsp;<strong>620nm</strong>&nbsp;peaks, which are the most efficient at stimulating photosynthesis.</p>
					
				</div>
			
			</section>
			
			<figure class="full-width">
				<img src="media/DSCF1962.jpg">
				<figcaption>Assembled greenhouse on a chair with seedlings.</figcaption>
			</figure>
					
			<section>
			
				<div class="sleeve">
				
					<h2>LED constant current driver</h2>
					
					<p>These days there are tons of commercial LED grow light fixtures available for purchase, ranging from tens to thousands of dollars. The ones that realistically mimic the light output of professional grow lights typically use 10s to 100s of the 1W (1 watt) or 3W LED components. With a per-piece cost of $1-$5, these fixtures often cost hundreds of dollars.</p>
					<p>Given the large fixed cost of the components themselves, I decided to try and save on the labor costs and build my own high-power LED lighting system. I based my design heavily off the instructions on&nbsp;<a href="http://www.instructables.com/id/Circuits-for-using-High-Power-LED-s/?ALLSTEPS">Dan Goldwater's LED power supply tutorial</a>. Specifically, I started from the constant-current design in&nbsp;<strong>Step 6</strong>.</p>
					<p>To save on shipping, I mostly used components I could get locally:</p>
					<ul>
					<li>IRF520N HEXFET power transistor (in place of&nbsp;Fairchild FQP50N06L)</li>
					<li>2N3904 NPN transistor (in place of&nbsp;Fairchild 2N5088BU)</li>
					<li>100 kOhm resistor</li>
					<li>2x 0.47 ohm (up to 5W) and 2x 1.0 ohm (up to 10W) power resistors from RadioShack</li>
					<li><a href="http://www.amazon.com/gp/product/B00FWO24US/ref=oh_details_o00_s00_i00?ie=UTF8&amp;psc=1">Intocircuit 120volt to 12-volt/30-watt power supply</a></li>
					</ul>
					<p>I started out with a basic knowledge of&nbsp;<a href="http://en.wikipedia.org/wiki/Ohm%27s_law">Ohm's Law</a>&nbsp;(i.e. V=IR) and&nbsp;<a href="http://en.wikipedia.org/wiki/Kirchhoff's_circuit_laws#Kirchhoff.27s_voltage_law_.28KVL.29">Kirchhoff's voltage law</a>, but had a difficult time understanding the constant current circuit. In my design, the Intocircuit power supply is converting 120V AC to 12V DC; the riskier part of the equation I didn't want to mess with myself. However, that power supply will deliver any amount of amps from 0 - 2.5, at 12V, that the net resistance of the circuit will dictate (see Ohm's Law). Our LED components are trickier, because if you connect them directly to the power supply they will draw more current than they need and quickly burn up; &nbsp;sort of like a person who can't control themselves at a buffet. Thus we need to put a&nbsp;<em>constant-current controller&nbsp;</em>between the 12V power supply and our LEDs. In some situations resistors could be used to limit the current flow, but at the high power level of our LEDs even minute temperature-dependent fluctuations in the amount of current they'll pass need to be actively controlled to avoid damage.</p>
					<p>Dan's constant current controller design uses the MOSFET power transistor to regulate the current flow through the LED circuit. The smaller transistor constitutes the negative feedback loop that causes the circuit to hold a fixed current flow. Overall I found Dan's description to be helpful, but there were a couple of values for which no explanation was given. In his calculation of LED current and R3 power, he uses the unlabeled constants 0.5 and 0.25. I believe I have identified where they come from, but it requires some brief discussion of how the circuit works:</p>
					<p>The Gate pin of the MOSFET is triggered by voltage level; For the IRF520 as little as 5V will turn it fully ON. In Dan's design, a 100 kOhm resistor from +V is used to raise the voltage at the Gate pin and turn the MOSFET, and thus LED string, on. The way in which our small NPN transistor created negative feedback is to open up and conduct from the Gate pin to ground, lowering the voltage at the Gate pin and turning the MOSFET off. The large-value resistor is important to ensure the current flowing through the small NPN transistor is negligible.</p>
					<p>How the small NPN transistor creates feedback is to exploit one of its data-sheet properties: V<sub>BE(sat)</sub>, or the Base-Emitter Saturation Voltage. V<sub>BE(sat)</sub> not only describes a voltage drop across the Base and Emitter pins, but it is also a threshold below which there is virtually no conduction from Collector to Emitter. With R3 in place, we know that the voltage at the Base of the small NPN is V<sub>BE</sub> = I<sub>MOSFET</sub> * R3.</p>
					<!--<p>The MOSFET power transistor we're using is "logic level", meaning the pin that controls the main power flow from the Drain to the Source is fully "ON" at just 5V, a common low voltage used in computer and micro controller circuits. From the circuit diagram we see R1 connecting our V+ positive supply voltage to the Gate pin (OK, because it can handle &gt;5V without damage). With that connection alone, the MOSFET would provide no regulation. With the NPN transistor connected between the MOSFET's gate and Ground, I could see how when it was full "ON" it would pull the Gate pin to 0V, stopping the flow of current through the LEDs. What stumped me was how the R3 calculation related to the NPN transistor modulating the Gate voltage (and thus the LED current flow). My understanding is that the feedback circuit relies on the behavior of the Base-Emitter Saturation Voltage V<sub>BE(sat)</sub>: Below that voltage the transistor will conduct no current from the Collector to Emitter. The goal when calculating R3, then, is to find the resistance that produces&nbsp;V<sub>BE(sat)</sub>&nbsp;at the your target amperage.&nbsp;</p>-->
					<ul>
					<li>As I<sub>MOSFET</sub> increases, V<sub>BE</sub> increases. When V<sub>BE</sub> reaches V<sub>BE(sat)</sub> the small NPN starts to conduct from Collector to Emitter and the voltage at the MOSFET's Gate pin drops.</li>
					<li>As the MOSFET Gate voltage decreases, the resistance between the MOSFET's Source and Drain increases, lowering I<sub>MOSFET</sub></li>
					<li>Eventually you reach a value of I<sub>MOSFET</sub> that balances with V<sub>BE</sub> so that you remain in a steady-current state.</li>
					</ul>
					<p>So the unlabeled value 0.5 in Dan's instructions is the V<sub>BE(sat)</sub> of his small NPN transistor. I measured V<sub>BE(sat)</sub> of my 2N3904 to be 0.572V. The other constant that went unlabeled was in calculating the power the R3 resistor needs to handle. Dan uses 0.25. Knowing Power = V * I and substituting I = V / R you get P = V<sup>2</sup>&nbsp;/ R. So it would appear that the constant in his power calculation is V<sub>BE(sat)</sub> squared.</p>
			
				</div>
			
			</section>
			
			<figure class="full-width">
				<img src="media/DSCF1945.jpg">
				<figcaption>Detail from top of LED base mounting hardware.  Central hole is a feedthrough for power lead.</figcaption>
			</figure>
			
			<section>
			
				<div class="sleeve">
				
					<h2>LED choice and considerations</h2>
				
					<p>After doing some research it seemed that the overwhelming consensus is that you can get cheap high-power LEDs from China but the quality is very hit-or-miss. For my first project I wanted to stick to something reliable so I would have fewer things to debug: &nbsp;That left Cree and Luxeon. I did some searching but the product lists at Digikey and Mouser were a little intimidating. I ended up ordering from the&nbsp;<a href="http://www.luxeonstar.com">Luxeon Star</a>&nbsp;website because their "Rebel" bases specifically mentioned easy soldering with simple tools and they have detailed data sheets for each product. I settled on the Rebel Tri-Star CoolBase models because of the slight discount per-LED over individual LEDs and ordered 6 "Red", 1 "Royal Blue" and 1 "Cyan" Tri-Star. That got my order to over $100 and earned free shipping. The Red and Royal Blue correspond very closely to my target PAR peaks at 620nm and 450nm while the Cyan just adds diversity. I chose the 3:1 ratio reds to blues loosely on observations of the commercial grow lamps.</p>
					<ul>
					<li>6x <span>Red (627nm) Rebel LEDs, Mounted on a 20mm Tri-Star CoolBase - 306 lm @ 700mA&nbsp;</span>(SR-03-D2050)</li>
					<li>1x&nbsp;<span>Royal-Blue (447.5nm) Rebel LEDs, Mounted on a 20mm Tri-Star CoolBase - 2670 mW @ 700mA (SR-03-R0800)</span></li>
					<li><span>1x&nbsp;<span>Cyan (505nm) Rebel LEDs, Mounted on a 20mm Tri-Star CoolBase - 366 lm @ 700mA (SR-03-E0070)</span></span></li>
					<li><span><span>2x Intocircuit 120V to 12V 2.5A power supplies</span></span></li>
					</ul>
					<p>It is important to consider your power supplies and constant current driver design when placing your LED order. The constant current driver design is only efficient when the voltage drop across the LEDs is very close to the voltage of the power supply. Any difference is burned off as heat by the MOSFET and just adds trouble. What you want to do is make combinations of LEDs whose Forward Voltage (Vf), the drop in voltage across them at power, adds up nearly to your power supply voltage. For me the power supply voltage is 12V. You'll want to refer to Kirchoff's law for how the Vf combines in series vs. parallel. I ended up with:</p>
					<ul>
						<li>3 strings with 2 Red, 1 Royal Blue, and 1 Cyan (Forward Voltage 10.85V)</li>
						<li>3 strings with 4 Red (Forward Voltage 9.2V)</li>
					</ul>
					
					<p><b>When matching the forward voltage of your strings of LEDs to your power supply, be sure to take into account both the voltage drop of the MOSFET and of R3!</b></p>
					
					<p>After I wired everything up I discovered a few problems with my plan. First, I neglected to consider voltage drops across the MOSFET and across R3. The voltage drop across the MOSFET is due to what the IRF520N data-sheet lists as R<sub>DS(on)</sub>: The resistance between Drain and Source when the MOSFET is fully ON, i.e. the lowest resistance it will ever have. In my case that is 0.2 Ohm, which at 2.1A is 0.42V. My second and third problems are due to the lack of options I had for low-ohm resistors.  I could only find 0.47 Ohm and 1.0 Ohm power resistors that cost about $2.50 a piece. With two 0.47 Ohm resistors in parallel I have R3 = 0.25 Ohm that is pretty close to our goal of 0.572V / 2.1A = 0.27 Ohm. Because the voltage drop across these as R3 was the smallest I paired it with the 10.85V LED string.</p>
					
					<figure>
						<img src="media/DSCF1964.jpg">
						<figcaption>Low-ohm power resistors connected in parallel, placed in front of fan for cooling.</figcaption>
					</figure>
					
					<p>Finally, I already had two 1 Ohm resistors so I put those in parallel to get 0.5 Ohm. At 2.1A we would get a voltage across R3 of 1.05V, which is well above the NPN's V<sub>BE(sat)</sub> of 0.572V. So I built a voltage divider with >1 kOhm resistors and used the output to drive the Base of the small NPN. This allowed me to use the low-ohm resistors I had even though the voltage across R3 was unsuitable for negative feedback. One downside to doing this is that the power dissipation through R3 is higher and generates more heat. The voltage divider isn't just useful when R3 is way off, I also used a voltage divider to fine-tune the current set-point of the other strings too.</p>
					
				</div>
				
			</section>
			
			<!--<figure class="full-width">
				<img src="media/DSCF1936.jpg">
				<figcaption>Breadboard, center, with current mirror circuit for 3x all-Red LED strings.</figcaption>
			</figure>
			
			<section>
				
				<div class="sleeve">
				
					<h2>Parallel LED string considerations</h2>
				
					<p>As a result of the 12V power supply choice I made, I can only handle about 5 high-power LEDs in series before the net forward voltage gets too high. However, each serial string of LEDs only draws 700mA current, much less than the 2.5A available from the power supply. My solution is to run several strings in parallel per power supply, so that I only need 2 power supplies total (as opposed to 6+) for my 24 LEDs.</p>
					<p>All of the constant current driver designs I had reviewed only covered multiple LEDs connected in serial. When I started searching for issues I had with uneven lighting between parallel strings, I found a variety of information about "thermal runaway" and its solution, a <strong>current mirror</strong>. The basic premise is that if strings are unbalanced either due to design or manufacturing tolerances, one may consume more current than another. The greater current consumption increases heat buildup, which in turn can increase the current through that string; &nbsp;creating a runaway situation. <a href="http://www.ledsmagazine.com/articles/print/volume-6/issue-2/features/led-design-forum-avoiding-thermal-runaway-when-driving-multiple-led-strings-magazine.html">This article</a> does a good job of explaining the issue and offering some designs for current mirrors. I also found <a href="http://ledlight.osram-os.com/wp-content/uploads/2010/05/AppGuideCurrentDistributioninParallelLEDStrings.Web_.pdf">a PDF from Osram</a> with similarly helpful information. Finally, for an explanation of how the current mirror itself works, <a href="http://en.wikipedia.org/wiki/Current_mirror#Basic_MOSFET_current_mirror">the Wikipedia entry</a> got me the closest to understanding.</p>
					<p>I ended up building the simplest current mirror circuit using 3x&nbsp;TIP120 NPN transistors, one for each of the all-Red LED strings. My other three strings so far haven't needed the current mirror.</p>
					<p>One important thing to note is that the transistors in the current mirror add another forward voltage drop to your string (in addition to the net Vf of the LEDs). In retrospect, I think my choice of the TIP120 was poor because it has a voltage drop of ~2V, which eats significantly into my 12V. As a result, I rewired my all-Red strings down to 4 in series so that my total forward voltage would be under 12.</p>
				
				</div>
				
			</section>-->
			
			<figure class="full-width">
				<img src="media/DSCF1940.jpg">
				<figcaption>Vent flap (closed) with lever arm and servo.</figcaption>
			</figure>
			
			<section>
			
				<div class="sleeve">
				
					<h2>Greenhouse construction and venting</h2>
				
					<p>To help focus on the electronics at this stage, I decided to go with a pre-made option for the greenhouse container. I knew I wanted something that could be totally enclosed, to control temperature and humidity. I decided to start with something cheap, so I found a 106 quart Rubbermaid tub at the local hardware store.</p>
					
					<figure>
						<img src="media/DSCF1954.jpg">
						<figcaption>A Tri-Star base secured to aluminum sheet.</figcaption>
					</figure>
					
					<figure>
						<img src="media/DSCF1946.jpg">
						<figcaption>All 8 Tri-Star bases mounted and wired.</figcaption>
					</figure>
					
					<p>Since heat-sinking the high-power LEDs is a significant concern, I chose a 1-foot square sheet of aluminum for mounting the LEDs. The aluminum is a decent thermal conductor yet soft enough to easily drill holes in for mounting items with screws. The Tri-Star bases have holes for #4 screws, so I bought 3x #4 machine screws and nuts per base. In the middle of my aluminum plate I mounted a re-used heatsink and around it I mounted each of the Tri-Star bases, with heatsink paste on all of them. I drilled extra holes lining up with the hole in the center of the Tri-Star bases to give me ports through which to route back wires. After mounting the LEDs I mapped out a plan for wiring together my 6 different series of LEDs.</p>
							
					<figure>
						<img src="media/DSCF1955.jpg">
						<figcaption>Balsa wood lip underneath aluminum sheet.</figcaption>
					</figure>
								
					<p>Then I cut a smaller hole in the lid of the container, leaving a 0.5" edge for the aluminum sheet to lay. I also superglued a balsa-wood lip on the underside of the sheet so it couldn't slide out of alignment with the hole in the lid, potentially damaging the LEDs or wiring.</p>
														
					<p>Finally, I cut a square section out of the side of the container, fairly high up, to act as my vent. After filing the edges to keep from getting caught up on burrs, I made a hinge out of tape, making the cut-out section into a door. I fashioned a small lever-arm out of balsa-wood and connected it to a servo with a bent piece of wire.</p>
					
				</div>
			
			</section>
			
			<figure class="full-width">
				<img src="media/DSCF1971.jpg">
				<figcaption>Balsa wood-framed enclosure to improve ducting of air over the LED assembly and constant current drivers.</figcaption>
			</figure>
			
			<section>
				
				<div class="sleeve">
				
					<h2>Humidity and temperature sensors</h2>
				
					<p>To know how to control the greenhouse we need to know what the current conditions are. I had experience with simpler temperature sensors like the TMP36, but ultimately ended up choosing the Honeywell HIH6100 series. This sensor appealed to me because it reported relative humidity (RH) and temperature and communicated digitally with just 2 pins using an Arduino-supported protocol called I<sup>2</sup>C. <a href="http://www.phanderson.com/arduino/hih6130.html">This code</a> worked great for quickly getting readings from the sensors.</p>
					<p>I made the mistake, however, of assuming that being able to chain&nbsp;I<sup>2</sup>C devices together would mean I could connect multiple HIH6100's. However, I couldn't find a way to change the slave address for my 2nd HIH6100 so that meant I had to come up with a way to multiplex them. Initially I tried using 2N3904 transistors to turn on the power to one sensor at a time, but that just had the effect of interrupting communication for the other sensor on the&nbsp;I<sup>2</sup>C bus. Instead, the solution that worked was to use the&nbsp;2N3904's to connect only one sensor's SDA (data) pin to the Arduino at a time. Then the process for measuring from two sensors becomes:</p>
					<ul>
					<li>Write HIGH to digital out for 2N3904 connected to Sensor A</li>
					<li>Request measurement from Sensor A</li>
					<li>Write LOW to digital out for&nbsp;2N3904 connected to Sensor A</li>
					<li>Write HIGH to digital out for 2N3904 connected to Sensor B</li>
					<li>Request measurement from Sensor B</li>
					<li>Write LOW to digital out for&nbsp;2N3904 connected to Sensor B</li>
					</ul>
					
				</div>
				
			</section>
			
			<figure class="full-width">
				<img src="media/DSCF1963.jpg">
				<figcaption>Aluminum sheet with mounted LEDs, power supplies, heatsinks, fan and constant current drivers on breadboard.</figcaption>
			</figure>
			
			<section>
				
				<div class="sleeve">
				
					<h2>Bluetooth LE shield for Arduino</h2>
				
					<p>A while back I purchased the RedBearLab Bluetooth LE shield for Arduino to play around with the Bluetooth LE support in iOS. If you're like me, you're new to Bluetooth LE development so the vast amount of new terminology is overwhelming at first. In RBL's official SDK you'll primarily find demos for UART and Firmata. The UART project simply sets up a bi-directional serial communication tunnel between the Arduino and iOS. Unfortunately this is a rather contrived example of Bluetooth LE communication, which is primarily designed to work through a system called GATT. </p>
					<p>In practical terms this means you create a fixed description of various properties that can be read or written to. The proprieties are named&nbsp;<strong>Characteristics</strong>&nbsp;and the characteristics are organized together into&nbsp;<strong>Services</strong>. It is common for a single characteristic to represent a single basic datatype such as an&nbsp;<strong>int</strong>,&nbsp;<strong>float</strong>, or&nbsp;<strong>boolean</strong>. A characteristic can have several modes:</p>
					<ul>
					<li>Read &ndash; Can be read</li>
					<li>Write &ndash; Can be written to, won't send an ACK</li>
					<li>Write With Response &ndash; Can be written to, will send ACK/NACK</li>
					<li>Notify &ndash; Slave transmits when the value changed</li>
					</ul>
					<p>Read and Write are fairly self explanatory. Notify is great for informing the BLE client when a value has changed instead of requiring the client to poll the slave every so often.</p>
					<p>The Arduino SDK for interfacing with the Nordic n8001 in the RedBearLabs shield relies on an abstraction called ACI. The default way of interfacing with the shield is by polling for updates over the ACI communication channel. I believe it's theoretically possible to use interrupts to replace the polling, but I haven't gone that far. Instead, you simply call aci_loop(), usually once per cycle of your Arduino sketch's loop(). This dispatches any queued messages to the shield and polls for any messages from the shield for you. Inside the aci_loop() function you switch() on the ACI Event's code to determine if that message indicates a change in status, receipt of data, an error, etc.</p>
					<p>To change the GATT profile, with the Services and Characteristics, you need to download a Windows-only app from Nordic Semiconductor called nRFgo Studio. I believe I had to register an account, but ultimately you shouldn't have to pay anything. I successfully ran the app in VirtualBox on my Mac. Once you have the app installed, you'll want to download the <a href="https://devzone.nordicsemi.com/arduino">Arduino SDK from Nordic</a> and look for the "examples" folder. It's the <strong>.xml</strong>&nbsp;that you'll actually open from within the nRFgo Studio app. From there, the only two tabs I've changed anything on are "GATT Services" and "GAP Settings". Without going into all the details, I can say that to create your own custom Services and Characteristics you must choose the options to create new templates and then drag the templates into the center list. You'll also want to "nRF8001 Setup &gt; Edit 128 bit UUIDs..." and add a new "base" UUID. One simple way is typing "uuidgen" at the command line in OSX. Once you've finished your configuration, choose "nRF8001 Setup &gt; Generate Source Files &gt; Generate only services.h" and choose where to save. You'll copy the new services.h into your Arduino project folder.</p>
					<p>The way you implement the Bluetooth LE Services and Characteristics was a little counter-intuitive to me. The Nordic nRFgo Studio application creates a services.h file with your configuration. In it, it #defines a number of named "pipes", each one which is uni-directional. A single Characteristic has individual pipes for each mode: read, write, write with response, notify, etc. You use these pipe identifiers to determine for which Characteristic data was received, or through which Characteristic to transmit data to the client. When a client WRITEs to the BLE shield or the BLE shield NOTIFYs the client, the data sent/received is ephemeral and the shield acts just as an intermediary. However, Characteristics that can be READ maintain that value in the memory of the BLE shield and requests by the client for that value are delivered directly from the shield without involving the application controller (e.g. the Arduino). The pipe names for the READs are postfixed counter-intuitively with "SET", I suppose signifying that you're setting the value in the board's memory.</p>
				
				</div>
				
			</section>
			
			<figure class="full-width">
				<img src="media/DSCF1967.jpg">
				<figcaption>Breadboard for Arduino with opto-isolators, I<sup>2</sup>C data line switching circuit, and servo connections.</figcaption>
			</figure>
			
			<section>
				
				<div class="sleeve">
				
					<h2>Balancing two goals with one passive control</h2>
					
					<p>Although more serious greenhouses often have active control over CO2 level, temperature, and humidity it's not uncommon for a greenhouse to have little control other than the opening and closing of louvers to let in outside air. In this small greenhouse we have one similar control: the vent flap. The LEDs are efficient enough that they don't create enough heat to act as a heater.</p>
					
					<p>When the flap is open our circulation fan is directing inside air out the vent, acting to equalize the interior conditions (humidity and temperature) with the exterior conditions. When the flap is closed, several things contribute to the internal conditions. Standing water can evaporate and plants will transpire, both raising the humidity. Sunlight may enter greenhouse and warm the trapped air. Choosing when to open and when to close the vent flap is key to keeping the interior climate at our goal, e.g. 70Â°F and 50% relative humidity (RH).</p>
					
					<p>I call the vent flap a passive control because in a best case scenario it has two options: maintain the natural internal climate or equalize with the external climate. An active control would look like a heater or A/C that can force the climate towards a desired set-point. The choice of when to operate our vent flap is complicated by the fact that it must attempt to satisfy two independent goals: a fixed temperature and a fixed humidity.</p>
					
					<p>To illustrate why achieving both goals with one control is complicated, consider the case where external temperature drops dramatically at night. The greenhouse's internal temperature is very near it's goal of 70Â°F, but transpiration from the plants is raising the humidity too high. If you open the vent to try and reduce RH by 1% you risk dropping the temperature by 20Â°! Obviously you need to weigh both the plusses and minuses.</p>
					
					<p>In another situation, the greenhouse could be just 1Â° above its temperature set-point yet have excellent interior humidity.  If there is a very slight temperature difference between interior and exterior, it would take a long time for the venting to reduce our internal temperature. However, if there is a large difference in humidity that long venting process could drastically reduce the interior humidity. In this case, trying to achieve the small temperature adjustment wasn't worth the damage done to our humidity level.</p>
					
					<p>One solution is to take into account both the <b>need</b> for adjustment as well as the <b>opportunity</b> for adjustment of each goal. The 'need' for adjustment can be represented as Need = X<sub>goal</sub> â X<sub>interior</sub>. The 'opportunity' for adjustment can be expressed as Opportunity = X<sub>interior</sub> â X<sub>exterior</sub>. We can then express the "necessity" of opening the vent as Necessity = Need * Opportunity.  Only when you have both the "need" and "opportunity" will the "necessity" be a positive value. No amount of need combined with zero opportunity will result in a positive necessity, which turns out to accurately describe real life.</p>
					
					<p>Now to take into account the necessity for both temperature and humidity we add the two together, N<sub>total</sub> = N<sub>temp</sub> + N<sub>hum</sub>. For completeness, we add coefficients to each term that we can tweak to balance both the difference in units but also what we perceive as their relative importance: N<sub>total</sub> = A*N<sub>temp</sub> + B*N<sub>hum</sub>. The end result is N<sub>total</sub>, which has the characteristic of being positive when venting will help us reach one or both goals or less than zero when venting won't help either goal or will help one goal but significantly hurt the other.</p>
					
				</div>
			
			</section>
			
			<!--<section>
				
				<div class="sleeve">
				
					<h2>Controlling LED lighting from Arduino</h2>
				
					<p>In <a href="http://www.instructables.com/id/Circuits-for-using-High-Power-LED-s/step8/a-little-micro-makes-all-the-difference/">Step 8</a>&nbsp;of Dan's constant current driver tutorial he shows a simple modification to allow controlling of the driver by a microcontroller, by simply wiring a digital out to the Gate pin of the MOSFET power transistor.</p>
					<p>Although not strictly necessary, I thought it would be good practice not to connect my Arduino (a 5V system) to the 12V lighting system, electrically. If anything were to fail or wires to get crossed it would be easy to toast the Arduino. I settled on buying a couple of&nbsp;MCT2EM-ND Opto-Isolators (a.k.a. Optocouplers). I connected the emitter to the digital out from the Arduino with a 100 ohm resistor and connected the +12V to the detector's Collector pin and the Emitter pin to the MOSFET power transistor's Gate, leaving the detector's Base pin un-connected. Finally, I added a 100 kOhm resistor between the MOSFET's Gate pin and Ground to keep it from floating when the Opto-isolator is "OFF". This way, when the Arduino outputs digital HIGH, the detector's NPN transistor goes "ON" and the Gate pin&nbsp;</p>
				
				</div>
				
			</section>-->
			
			<!--
			<footer>
				<p>This project is maintained by <a href="https://github.com/cconway">cconway</a></p>
				<p><small>Hosted on GitHub Pages &mdash; Theme by <a href="https://github.com/orderedlist">orderedlist</a></small></p>
			</footer>
			-->
		
		</div>
		<!--<script src="javascripts/scale.fix.js"></script>-->
	
	</body>
</html>